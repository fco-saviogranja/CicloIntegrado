<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificações - Ciclo Integrado</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        if (typeof tailwind !== 'undefined') {
            tailwind.suppressWarnings = true;
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Readex+Pro:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="../js/api.js"></script>
    <script src="../js/user-header.js"></script>
    
    <style>
        :root {
            --primary: #ff5a2e;
            --primary-medium: #fe8222;
            --primary-light: #fd931d;
        }
        body { font-family: 'Readex Pro', sans-serif; }
        .gradient-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-medium) 50%, var(--primary-light) 100%);
        }
        .sidebar-hidden { transform: translateX(-100%); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>
    
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white border-r border-gray-200 z-40 transition-transform duration-300 lg:translate-x-0 sidebar-hidden">
        <div class="flex items-center justify-center border-b border-gray-200 px-4 py-3">
            <svg width="120" height="30" viewBox="0 0 160 40" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff5a2e;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#fe8222;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#fd931d;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="16" cy="20" r="12" fill="url(#logoGradient)"/>
                <circle cx="16" cy="20" r="6" fill="white"/>
                <text x="36" y="24" font-family="Readex Pro, sans-serif" font-size="14" font-weight="600" fill="#1f2937">Ciclo Integrado</text>
            </svg>
        </div>
        
        <div id="municipio-logo-container" class="flex flex-col items-center justify-center border-b border-gray-200 px-4 py-4 bg-gray-50">
            <div id="municipio-logo" class="w-16 h-16 rounded-full bg-gradient-to-br from-orange-400 to-orange-600 flex items-center justify-center text-white font-bold text-xl shadow-lg"></div>
            <p id="municipio-nome" class="mt-2 text-xs font-semibold text-gray-700 text-center">Carregando...</p>
        </div>
        
        <nav class="p-4 space-y-1">
            <a href="ciclo-dashboard.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">Dashboard</span>
            </a>
            <a href="ciclo-contratos.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-lucide="file-text" class="w-5 h-5"></i>
                <span class="font-medium">Contratos</span>
            </a>
            <a href="ciclo-cadastro.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-lucide="file-plus" class="w-5 h-5"></i>
                <span class="font-medium">Novo Contrato</span>
            </a>
            <a href="ciclo-relatorios.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors">
                <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                <span class="font-medium">Relatórios</span>
            </a>
            
            <div class="pt-4 border-t border-gray-200 mt-4 space-y-1">
                <a id="menu-configuracoes" href="ciclo-configuracoes.html" class="flex items-center gap-3 px-4 py-3 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors" style="display:none;">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                    <span class="font-medium">Configurações</span>
                </a>
                <a href="#" onclick="logout()" class="flex items-center gap-3 px-4 py-3 rounded-lg text-red-600 hover:bg-red-50 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                    <span class="font-medium">Sair</span>
                </a>
            </div>
        </nav>
    </aside>
    
    <main class="lg:ml-64 min-h-screen">
        <header class="bg-white border-b border-gray-200 sticky top-0 z-20">
            <div class="flex items-center justify-between px-4 sm:px-6 lg:px-8 h-16">
                <button id="menuBtn" class="lg:hidden p-2 rounded-lg hover:bg-gray-100">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 class="text-lg font-bold text-gray-900">Notificações</h2>
                <div class="flex items-center gap-3">
                    <button onclick="markAllRead()" class="text-sm font-medium" style="color: var(--primary);">
                        Marcar todas como lidas
                    </button>
                    <div class="relative">
                        <button id="userMenuBtn" class="flex items-center gap-3 px-2 py-1 rounded-lg hover:bg-gray-100">
                            <img id="userPhoto" src="" alt="Foto" class="w-10 h-10 rounded-full object-cover border-2 border-gray-200" style="display:none;">
                            <div id="userPhotoPlaceholder" class="w-10 h-10 rounded-full gradient-primary flex items-center justify-center text-white font-bold">
                                <span id="userInitials">?</span>
                            </div>
                            <div class="hidden sm:block text-left">
                                <p class="text-sm font-medium text-gray-900" id="userName">Carregando...</p>
                                <p class="text-xs text-gray-500" id="userRole">...</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                        </button>
                        <div id="userMenuDropdown" class="absolute right-0 mt-2 w-56 bg-white border border-gray-200 rounded-xl shadow-lg hidden z-30">
                            <div class="px-4 py-3 border-b border-gray-100">
                                <p class="text-sm font-semibold text-gray-900" id="dropdownUserName">Carregando...</p>
                                <p class="text-xs text-gray-500" id="dropdownUserRole">...</p>
                            </div>
                            <a href="ciclo-perfil.html" class="flex items-center gap-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50">
                                <i data-lucide="user" class="w-4 h-4"></i>
                                <span>Meu Perfil</span>
                            </a>
                            <button onclick="logout()" class="w-full text-left flex items-center gap-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 border-t border-gray-100">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                <span>Sair do sistema</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- Filter Tabs -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-2 flex gap-2">
                    <button onclick="filterNotifications('all')" class="flex-1 px-4 py-2 rounded-lg font-medium text-white gradient-primary">
                        Todas (12)
                    </button>
                    <button onclick="filterNotifications('unread')" class="flex-1 px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100">
                        Não lidas (5)
                    </button>
                    <button onclick="filterNotifications('important')" class="flex-1 px-4 py-2 rounded-lg font-medium text-gray-700 hover:bg-gray-100">
                        Importantes (3)
                    </button>
                </div>
                
                <!-- Notifications List -->
                <div class="space-y-4" id="notificationsList">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>
    </main>
    
    <script>
        lucide.createIcons();
        
        function loadMunicipioInfo() {
            try {
                const user = API.getCurrentUser();
                if (user && user.municipio_nome) {
                    const palavras = user.municipio_nome.split(' ').filter(p => p.length > 0);
                    const iniciais = palavras.map(palavra => palavra[0].toUpperCase()).join('').substring(0, 2);
                    
                    const municipioLogoEl = document.getElementById('municipio-logo');
                    const municipioNomeEl = document.getElementById('municipio-nome');
                    
                    if (municipioLogoEl) {
                        municipioLogoEl.textContent = iniciais;
                    }
                    if (municipioNomeEl) {
                        municipioNomeEl.textContent = user.municipio_nome;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar informações do município:', error);
            }
        }
        
        loadMunicipioInfo();
        
        // Mostrar menu Configurações apenas para Admin Municipal/Master (aceita grafia admin_municipio)
        try {
            const user = API.getCurrentUser();
            const menuConfigEl = document.getElementById('menu-configuracoes');
            const isAdminMunicipal = user && (user.role === 'admin_municipal' || user.role === 'admin_municipio');
            const isAdminMaster = user && user.role === 'admin_master';
            if (menuConfigEl && (isAdminMunicipal || isAdminMaster)) {
                menuConfigEl.style.display = 'flex';
            }
        } catch (error) {
            console.error('Erro ao verificar role do usuário:', error);
        }
        
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        
        menuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('sidebar-hidden');
            overlay.classList.toggle('hidden');
        });
        
        overlay.addEventListener('click', () => {
            sidebar.classList.add('sidebar-hidden');
            overlay.classList.add('hidden');
        });
        
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                API.logout();
                window.location.href = '../pages/login.html';
            }
        }
        
        function filterNotifications(type) {
            console.log('Filter:', type);
            loadNotifications();
        }
        
        function markAllRead() {
            if (confirm('Marcar todas as notificações como lidas?')) {
                loadNotifications();
            }
        }
        
        function markAsRead(id) {
            console.log('Mark as read:', id);
            loadNotifications();
        }
        
        function deleteNotification(id) {
            if (confirm('Deseja realmente excluir esta notificação?')) {
                console.log('Delete:', id);
                loadNotifications();
            }
        }
        
        function loadNotifications() {
            const notifications = [
                {
                    id: 1,
                    type: 'alert',
                    icon: 'alert-triangle',
                    color: 'red',
                    title: 'Contrato vencendo em 7 dias',
                    message: 'O contrato #001/2024 (Serviços de Limpeza Urbana) vencerá em 7 dias.',
                    time: 'Há 2 horas',
                    read: false,
                    important: true
                },
                {
                    id: 2,
                    type: 'success',
                    icon: 'check-circle',
                    color: 'green',
                    title: 'Pagamento efetuado',
                    message: 'Pagamento de R$ 87.500,00 referente ao contrato #001/2024 foi confirmado.',
                    time: 'Há 4 horas',
                    read: false,
                    important: false
                },
                {
                    id: 3,
                    type: 'info',
                    icon: 'file-text',
                    color: 'blue',
                    title: 'Novo documento anexado',
                    message: 'Nota fiscal #002 foi anexada ao contrato #003/2024.',
                    time: 'Há 6 horas',
                    read: false,
                    important: false
                },
                {
                    id: 4,
                    type: 'alert',
                    icon: 'alert-circle',
                    color: 'yellow',
                    title: 'Pendência de fiscalização',
                    message: 'Contrato #005/2024 está sem relatório de fiscalização há 30 dias.',
                    time: 'Há 1 dia',
                    read: false,
                    important: true
                },
                {
                    id: 5,
                    type: 'info',
                    icon: 'user-plus',
                    color: 'purple',
                    title: 'Novo usuário cadastrado',
                    message: 'Pedro Oliveira foi cadastrado como Fiscal de Contrato.',
                    time: 'Há 1 dia',
                    read: false,
                    important: false
                },
                {
                    id: 6,
                    type: 'success',
                    icon: 'check-circle',
                    color: 'green',
                    title: 'Contrato renovado',
                    message: 'Contrato #002/2024 foi renovado por mais 12 meses.',
                    time: 'Há 2 dias',
                    read: true,
                    important: false
                },
                {
                    id: 7,
                    type: 'alert',
                    icon: 'alert-triangle',
                    color: 'red',
                    title: 'Contrato vencido',
                    message: 'O contrato #010/2023 venceu e precisa ser renovado ou encerrado.',
                    time: 'Há 3 dias',
                    read: true,
                    important: true
                },
                {
                    id: 8,
                    type: 'info',
                    icon: 'edit',
                    color: 'blue',
                    title: 'Contrato atualizado',
                    message: 'Dados do contrato #004/2024 foram atualizados por Ana Costa.',
                    time: 'Há 3 dias',
                    read: true,
                    important: false
                }
            ];
            
            const list = document.getElementById('notificationsList');
            list.innerHTML = notifications.map(notif => `
                <div class="bg-white rounded-xl shadow-sm border ${notif.read ? 'border-gray-200' : 'border-orange-200 border-2'} p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-lg bg-${notif.color}-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="${notif.icon}" class="w-5 h-5 text-${notif.color}-600"></i>
                        </div>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-4 mb-1">
                                <h4 class="text-sm font-bold text-gray-900">${notif.title}</h4>
                                <div class="flex items-center gap-2">
                                    ${notif.important ? '<span class="px-2 py-0.5 text-xs font-semibold rounded-full bg-red-100 text-red-800">Importante</span>' : ''}
                                    ${!notif.read ? '<div class="w-2 h-2 rounded-full bg-orange-500"></div>' : ''}
                                </div>
                            </div>
                            <p class="text-sm text-gray-600 mb-2">${notif.message}</p>
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-500">${notif.time}</span>
                                <div class="flex items-center gap-2">
                                    ${!notif.read ? `
                                        <button onclick="markAsRead(${notif.id})" class="text-xs font-medium text-blue-600 hover:text-blue-800">
                                            Marcar como lida
                                        </button>
                                    ` : ''}
                                    <button onclick="deleteNotification(${notif.id})" class="p-1 hover:bg-gray-100 rounded">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-gray-400"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }
        
        loadNotifications();
    </script>
</body>
</html>
